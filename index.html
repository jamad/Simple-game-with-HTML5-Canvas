<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Canvas Game</title>
<style>
  body { margin:0; text-align:center; }
  canvas { border:1px solid #000; display:block; margin:auto; }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<script>
const CONFIG = {
  width: 320,
  height: 500,
  platformWidth: 70,
  platformHeight: 20,
  circleCount: 10,
  platformCount: 7
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = CONFIG.width;
canvas.height = CONFIG.height;

let points = 0, isRunning = true;

// ===== 背景の円 =====
const circles = Array.from({length: CONFIG.circleCount}, () => ({
  x: Math.random() * CONFIG.width,
  y: Math.random() * CONFIG.height,
  r: Math.random() * 100,
  alpha: Math.random() / 2
}));

function drawBackground() {
  ctx.fillStyle = '#d0e7f9';
  ctx.fillRect(0, 0, CONFIG.width, CONFIG.height);
  circles.forEach(c => {
    ctx.fillStyle = `rgba(255,255,255,${c.alpha})`;
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
    ctx.fill();
  });
}

function moveCircles(speed) {
  circles.forEach(c => {
    c.y = c.y - c.r > CONFIG.height
      ? (c.x = Math.random() * CONFIG.width, c.r = Math.random() * 100, c.y = -c.r, c.alpha = Math.random() / 2, c.y)
      : c.y + speed;
  });
}

// ===== Player クラス =====
class Player {
  constructor() {
    this.img = new Image();
    this.img.src = "angel.png";
    this.w = 65; this.h = 95;
    this.frames = 2;
    this.actualFrame = 0;
    this.interval = 0;
    this.x = (CONFIG.width - this.w) / 2;
    this.y = CONFIG.height - this.h;
    this.jumpSpeed = 0; this.fallSpeed = 0;
    this.isJumping = false; this.isFalling = false;
  }

  draw() {
    if (!this.img.complete) return;
    ctx.drawImage(this.img, 0, this.h * this.actualFrame, this.w, this.h, this.x, this.y, this.w, this.h);
    if (++this.interval % 4 === 0) {
      this.actualFrame = (this.actualFrame + 1) % this.frames;
    }
  }

  jump() {
    if (!this.isJumping && !this.isFalling) {
      this.isJumping = true;
      this.jumpSpeed = 17;
    }
  }

  updateJump() {
    if (this.y > CONFIG.height * 0.4) {
      this.y -= this.jumpSpeed;
    } else {
      if (this.jumpSpeed > 10) points++;
      moveCircles(this.jumpSpeed * 0.5);
      platforms.forEach(p => { p.y += this.jumpSpeed; if (p.y > CONFIG.height) p.reset(); });
    }
    if (--this.jumpSpeed <= 0) {
      this.isJumping = false;
      this.isFalling = true;
      this.fallSpeed = 1;
    }
  }

  updateFall() {
    if (this.y < CONFIG.height - this.h) {
      this.y += this.fallSpeed++;
    } else {
      points ? gameOver() : this.fallStop();
    }
  }

  fallStop() { this.isFalling = false; this.fallSpeed = 0; this.jump(); }
  moveLeft() { if (this.x > 0) this.x -= 5; }
  moveRight() { if (this.x + this.w < CONFIG.width) this.x += 5; }
}

const player = new Player();

// ===== Platform クラス =====
class Platform {
  constructor(x, y, type) {
    this.x = x; this.y = y; this.type = type;
    this.isMoving = Math.random() < 0.5;
    this.dir = Math.random() < 0.5 ? -1 : 1;
  }

  draw() {
    const g = ctx.createRadialGradient(this.x + CONFIG.platformWidth / 2, this.y + CONFIG.platformHeight / 2, 5,
                                       this.x + CONFIG.platformWidth / 2, this.y + CONFIG.platformHeight / 2, 45);
    g.addColorStop(0, this.type ? '#AADD00' : '#FF8C00');
    g.addColorStop(1, this.type ? '#698B22' : '#EEEE00');
    ctx.fillStyle = g;
    ctx.fillRect(this.x, this.y, CONFIG.platformWidth, CONFIG.platformHeight);
  }

  reset() {
    this.x = Math.random() * (CONFIG.width - CONFIG.platformWidth);
    this.y -= CONFIG.height;
    this.type = Math.random() < 0.2;
  }
}

const platforms = Array.from({length: CONFIG.platformCount}, (_, i) =>
  new Platform(Math.random() * (CONFIG.width - CONFIG.platformWidth), i * (CONFIG.height / CONFIG.platformCount), Math.random() < 0.2)
);

// ===== 衝突判定 =====
function checkCollision() {
  platforms.forEach(p => {
    if (player.isFalling &&
        player.x < p.x + CONFIG.platformWidth &&
        player.x + player.w > p.x &&
        player.y + player.h > p.y &&
        player.y + player.h < p.y + CONFIG.platformHeight) {
      p.type ? (player.fallStop(), player.jumpSpeed = 50) : player.fallStop();
    }
  });
}

// ===== ゲームオーバー =====
function gameOver() {
  isRunning = false;
  ctx.fillStyle = "black";
  ctx.font = "10pt Arial";
  ctx.fillText(`GAME OVER`, CONFIG.width / 2 - 60, CONFIG.height / 2 - 50);
  ctx.fillText(`YOUR RESULT: ${points}`, CONFIG.width / 2 - 60, CONFIG.height / 2 - 30);
}

// ===== イベント =====
document.onmousemove = e => e.pageX < player.x + canvas.offsetLeft ? player.moveLeft() : player.moveRight();

// ===== ゲームループ =====
function loop() {
  drawBackground();
  if (player.isJumping) player.updateJump();
  if (player.isFalling) player.updateFall();
  player.draw();
  platforms.forEach((p, i) => {
    if (p.isMoving) {
      p.x += p.dir * (i / 2) * ~~(points / 100);
      if (p.x < 0) p.dir = 1;
      if (p.x > CONFIG.width - CONFIG.platformWidth) p.dir = -1;
    }
    p.draw();
  });
  checkCollision();
  ctx.fillStyle = "black";
  ctx.fillText(`POINTS: ${points}`, 10, CONFIG.height - 10);
  if (isRunning) requestAnimationFrame(loop);
}

player.img.onload = () => { player.jump(); loop(); };
</script>
</body>
</html>
